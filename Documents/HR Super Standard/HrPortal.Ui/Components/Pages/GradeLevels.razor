@page "/grade-levels"
@inject HttpClient Http

<PageTitle>Grade Levels</PageTitle>

<div class="designations-page">
    <h3>Grade Levels</h3>
    <form class="add-form grid-form" @onsubmit="CreateGrade">
        <div class="field">
            <label>Grade Level</label>
            <input @bind="newName" placeholder="Grade Level" required />
        </div>
        <div class="field">
            <label>Annual Basic</label>
            <InputNumber @bind-Value="newAnnualBasic" TValue="decimal?" step="0.01" placeholder="Enter annual basic" class="text-input" />
        </div>
        <div class="field">
            <label>Ranking</label>
            <InputNumber @bind-Value="newRanking" TValue="int?" min="1" placeholder="Enter ranking" class="text-input" />
        </div>
        <div class="field actions-row">
            <button class="cta" type="submit">Save</button>
            @if (!string.IsNullOrWhiteSpace(error))
            {
                <span class="error">@error</span>
            }
        </div>
    </form>

    <div class="designation-list">
        <div class="list-header grades-header">
            <div>Grade</div>
            <div>Annual Basic</div>
            <div>Ranking</div>
            <div class="actions">Actions</div>
        </div>
        @if (items.Count == 0)
        {
            <div class="row empty">No grades yet.</div>
        }
        else
        {
            @foreach (var item in items)
            {
                <div class="row grades-row">
                    @if (editId == item.Id)
                    {
                        <input @bind="editName" class="inline-input" />
                        <InputNumber @bind-Value="editAnnualBasic" TValue="decimal?" step="0.01" class="inline-input" placeholder="Annual basic" />
                        <InputNumber @bind-Value="editRanking" TValue="int?" min="1" class="inline-input" placeholder="Ranking" />
                    }
                    else
                    {
                        <div>@item.Name</div>
                        <div>@item.AnnualBasic</div>
                        <div>@item.Ranking</div>
                    }
                    <div class="actions">
                        @if (editId == item.Id)
                        {
                            <button type="button" @onclick="@(() => SaveEdit(item.Id))">Save</button>
                            <button type="button" @onclick="CancelEdit">Cancel</button>
                        }
                        else
                        {
                            <button type="button" @onclick="@(() => BeginEdit(item))">Edit</button>
                            <button type="button" class="danger" @onclick="@(() => Delete(item.Id))">Delete</button>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private List<GradeLevelDto> items = new();
    private string newName = string.Empty;
    private decimal? newAnnualBasic;
    private int? newRanking;
    private string error = string.Empty;

    private int? editId = null;
    private string editName = string.Empty;
    private decimal? editAnnualBasic;
    private int? editRanking;

    public record GradeLevelDto(int Id, string Name, decimal AnnualBasic, int Ranking);

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        error = string.Empty;
        try
        {
            items = await Http.GetFromJsonAsync<List<GradeLevelDto>>("grade-levels") ?? new();
        }
        catch
        {
            error = "Unable to load grade levels.";
        }
    }

    private async Task CreateGrade()
    {
        error = string.Empty;
        try
        {
            if (newAnnualBasic is null || newRanking is null)
            {
                error = "Annual Basic and Ranking are required.";
                return;
            }
            var resp = await Http.PostAsJsonAsync("grade-levels", new { Name = newName, AnnualBasic = newAnnualBasic.Value, Ranking = newRanking.Value });
            if (resp.IsSuccessStatusCode)
            {
                newName = string.Empty;
                newAnnualBasic = null;
                newRanking = null;
                await Load();
            }
            else
            {
                error = "Could not add grade level.";
            }
        }
        catch
        {
            error = "Could not add grade level.";
        }
    }

    private void BeginEdit(GradeLevelDto g)
    {
        editId = g.Id;
        editName = g.Name;
        editAnnualBasic = g.AnnualBasic;
        editRanking = g.Ranking;
        error = string.Empty;
    }

    private void CancelEdit()
    {
        editId = null;
        editName = string.Empty;
        editAnnualBasic = null;
        editRanking = null;
    }

    private async Task SaveEdit(int id)
    {
        error = string.Empty;
        try
        {
            if (editAnnualBasic is null || editRanking is null)
            {
                error = "Annual Basic and Ranking are required.";
                return;
            }

            var resp = await Http.PutAsJsonAsync($"grade-levels/{id}", new { Name = editName, AnnualBasic = editAnnualBasic.Value, Ranking = editRanking.Value });
            if (resp.IsSuccessStatusCode)
            {
                CancelEdit();
                await Load();
            }
            else
            {
                error = "Could not save changes.";
            }
        }
        catch
        {
            error = "Could not save changes.";
        }
    }

    private async Task Delete(int id)
    {
        error = string.Empty;
        try
        {
            var resp = await Http.DeleteAsync($"grade-levels/{id}");
            if (resp.IsSuccessStatusCode)
            {
                await Load();
            }
            else
            {
                error = "Could not delete.";
            }
        }
        catch
        {
            error = "Could not delete.";
        }
    }
}
